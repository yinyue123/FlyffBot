<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WASM Memory Scanner - æµè§ˆå™¨ç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Consolas', 'Monaco', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #4ec9b0;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .panel {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .panel-title {
      color: #569cd6;
      font-size: 16px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    input, select, button {
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      padding: 8px 12px;
      border-radius: 3px;
      font-family: inherit;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #007acc;
    }

    button {
      cursor: pointer;
      background: #0e639c;
      border-color: #007acc;
      transition: background 0.2s;
    }

    button:hover {
      background: #1177bb;
    }

    button:active {
      background: #005a9e;
    }

    button.danger {
      background: #c72e0f;
      border-color: #f14c4c;
    }

    button.danger:hover {
      background: #e03e1f;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 14px;
    }

    .stat-item {
      color: #ce9178;
    }

    .stat-value {
      color: #4ec9b0;
      font-weight: bold;
    }

    .results {
      max-height: 400px;
      overflow-y: auto;
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 3px;
      padding: 10px;
    }

    .result-item {
      display: grid;
      grid-template-columns: 100px 150px 150px 80px;
      gap: 10px;
      padding: 5px;
      border-bottom: 1px solid #333;
      font-size: 13px;
    }

    .result-item:hover {
      background: #2a2d2e;
    }

    .address {
      color: #4ec9b0;
      font-weight: bold;
    }

    .value {
      color: #b5cea8;
    }

    .type {
      color: #569cd6;
    }

    .action-btn {
      padding: 2px 8px;
      font-size: 11px;
    }

    .log {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 3px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }

    .log-entry {
      padding: 2px 0;
      color: #cccccc;
    }

    .log-entry.info {
      color: #4ec9b0;
    }

    .log-entry.success {
      color: #6a9955;
    }

    .log-entry.error {
      color: #f48771;
    }

    .instructions {
      background: #264f78;
      border-left: 4px solid #007acc;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
    }

    .instructions code {
      background: #1e1e1e;
      padding: 2px 6px;
      border-radius: 2px;
      color: #ce9178;
    }

    .watch-list {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 3px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .watch-item {
      display: grid;
      grid-template-columns: 100px 150px 80px 100px;
      gap: 10px;
      padding: 8px;
      border-bottom: 1px solid #333;
      animation: highlight 0.5s ease;
    }

    @keyframes highlight {
      0% { background: #2a2d2e; }
      100% { background: transparent; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” WASM Memory Scanner</h1>

    <div class="instructions">
      <strong>ä½¿ç”¨è¯´æ˜:</strong><br>
      1. åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ <code>attachScanner(wasmMemory)</code> æ¥è¿æ¥ WASM å†…å­˜<br>
      2. è¾“å…¥å½“å‰å€¼è¿›è¡Œé¦–æ¬¡æ‰«æ (First Scan)<br>
      3. æ”¹å˜æ¸¸æˆä¸­çš„å€¼ï¼Œè¾“å…¥æ–°å€¼ç»§ç»­æ‰«æ (Next Scan)<br>
      4. é‡å¤æ­¥éª¤ 3 ç›´åˆ°æ‰¾åˆ°å”¯ä¸€åœ°å€<br>
      5. å¯ä»¥ä¿®æ”¹å€¼æˆ–æ·»åŠ åˆ°ç›‘æ§åˆ—è¡¨
    </div>

    <!-- æ‰«ææ§åˆ¶ -->
    <div class="panel">
      <div class="panel-title">æ‰«ææ§åˆ¶</div>
      <div class="controls">
        <input type="number" id="searchValue" placeholder="è¾“å…¥è¦æœç´¢çš„å€¼" step="any">
        <select id="valueType">
          <option value="int8">Int8</option>
          <option value="uint8">UInt8</option>
          <option value="int16">Int16</option>
          <option value="uint16">UInt16</option>
          <option value="int32" selected>Int32</option>
          <option value="uint32">UInt32</option>
          <option value="float32">Float32</option>
          <option value="float64">Float64</option>
        </select>
        <select id="compareType">
          <option value="exact">ç²¾ç¡®å€¼</option>
          <option value="changed">å·²æ”¹å˜</option>
          <option value="unchanged">æœªæ”¹å˜</option>
          <option value="increased">å¢åŠ </option>
          <option value="decreased">å‡å°‘</option>
        </select>
      </div>
      <div class="controls">
        <button onclick="firstScan()">ğŸ” é¦–æ¬¡æ‰«æ (First Scan)</button>
        <button onclick="nextScan()">ğŸ”„ ç»§ç»­æ‰«æ (Next Scan)</button>
        <button onclick="resetScan()" class="danger">ğŸ—‘ï¸ é‡ç½®</button>
      </div>
      <div class="stats">
        <div class="stat-item">ç»“æœæ•°: <span class="stat-value" id="resultCount">0</span></div>
        <div class="stat-item">å†…å­˜å¤§å°: <span class="stat-value" id="memorySize">æœªè¿æ¥</span></div>
        <div class="stat-item">æ‰«ææ—¶é—´: <span class="stat-value" id="scanTime">-</span></div>
      </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    <div class="panel">
      <div class="panel-title">æœç´¢ç»“æœ (æ˜¾ç¤ºå‰ 100 æ¡)</div>
      <div class="results" id="resultsContainer">
        <div style="color: #858585; text-align: center; padding: 20px;">
          ç­‰å¾…æ‰«æ...
        </div>
      </div>
    </div>

    <!-- å†…å­˜ä¿®æ”¹ -->
    <div class="panel">
      <div class="panel-title">å†…å­˜ä¿®æ”¹</div>
      <div class="controls">
        <input type="text" id="modifyAddress" placeholder="åœ°å€ (hex: 0x1234 æˆ– dec: 1234)">
        <input type="number" id="modifyValue" placeholder="æ–°å€¼" step="any">
        <select id="modifyType">
          <option value="int8">Int8</option>
          <option value="uint8">UInt8</option>
          <option value="int16">Int16</option>
          <option value="uint16">UInt16</option>
          <option value="int32" selected>Int32</option>
          <option value="uint32">UInt32</option>
          <option value="float32">Float32</option>
          <option value="float64">Float64</option>
        </select>
        <button onclick="modifyMemory()">âœï¸ ä¿®æ”¹å†…å­˜</button>
      </div>
    </div>

    <!-- ç›‘æ§åˆ—è¡¨ -->
    <div class="panel">
      <div class="panel-title">å®æ—¶ç›‘æ§ (æ¯ç§’æ›´æ–°)</div>
      <div class="watch-list" id="watchList">
        <div style="color: #858585; text-align: center; padding: 20px;">
          ç›‘æ§åˆ—è¡¨ä¸ºç©º
        </div>
      </div>
      <button onclick="clearWatchList()" class="danger" style="margin-top: 10px;">æ¸…ç©ºç›‘æ§åˆ—è¡¨</button>
    </div>

    <!-- æ—¥å¿— -->
    <div class="panel">
      <div class="panel-title">æ—¥å¿—</div>
      <div class="log" id="logContainer"></div>
    </div>
  </div>

  <script src="memory-scanner.js"></script>
  <script>
    let scanner = null;
    let watchInterval = null;
    let watchList = [];

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(message);
    }

    // è¿æ¥åˆ° WASM å†…å­˜
    window.attachScanner = function(wasmMemory) {
      if (!wasmMemory) {
        log('é”™è¯¯: è¯·æä¾›æœ‰æ•ˆçš„ WASM Memory å¯¹è±¡', 'error');
        alert('è¯·åœ¨æ§åˆ¶å°è¿è¡Œ: attachScanner(wasmInstance.exports.memory)');
        return;
      }

      scanner = new WasmMemoryScanner(wasmMemory);
      updateMemorySize();
      log('å·²è¿æ¥åˆ° WASM å†…å­˜', 'success');

      // å¯åŠ¨ç›‘æ§
      startWatchInterval();
    };

    // æ›´æ–°å†…å­˜å¤§å°æ˜¾ç¤º
    function updateMemorySize() {
      if (scanner) {
        const size = scanner.buffer.length;
        const sizeMB = (size / 1024 / 1024).toFixed(2);
        document.getElementById('memorySize').textContent = `${sizeMB} MB`;
      }
    }

    // é¦–æ¬¡æ‰«æ
    function firstScan() {
      if (!scanner) {
        log('é”™è¯¯: æœªè¿æ¥åˆ° WASM å†…å­˜', 'error');
        return;
      }

      const value = parseFloat(document.getElementById('searchValue').value);
      const type = document.getElementById('valueType').value;

      if (isNaN(value)) {
        log('é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼', 'error');
        return;
      }

      log(`å¼€å§‹é¦–æ¬¡æ‰«æ: å€¼=${value}, ç±»å‹=${type}`, 'info');
      const startTime = performance.now();

      const results = scanner.firstScan(value, type);

      const endTime = performance.now();
      const scanTime = ((endTime - startTime) / 1000).toFixed(2);

      document.getElementById('scanTime').textContent = `${scanTime}s`;
      document.getElementById('resultCount').textContent = results.length;

      displayResults(results);
      log(`æ‰«æå®Œæˆ: æ‰¾åˆ° ${results.length} ä¸ªç»“æœ`, 'success');
    }

    // ç»§ç»­æ‰«æ
    function nextScan() {
      if (!scanner || scanner.searchResults.length === 0) {
        log('é”™è¯¯: è¯·å…ˆæ‰§è¡Œé¦–æ¬¡æ‰«æ', 'error');
        return;
      }

      const value = parseFloat(document.getElementById('searchValue').value);
      const compareType = document.getElementById('compareType').value;

      if (compareType === 'exact' && isNaN(value)) {
        log('é”™è¯¯: ç²¾ç¡®å€¼æ¨¡å¼éœ€è¦è¾“å…¥æ•°å€¼', 'error');
        return;
      }

      log(`ç»§ç»­æ‰«æ: æ¯”è¾ƒç±»å‹=${compareType}`, 'info');
      const startTime = performance.now();

      const results = scanner.nextScan(value, compareType);

      const endTime = performance.now();
      const scanTime = ((endTime - startTime) / 1000).toFixed(2);

      document.getElementById('scanTime').textContent = `${scanTime}s`;
      document.getElementById('resultCount').textContent = results.length;

      displayResults(results);
      log(`æ‰«æå®Œæˆ: å‰©ä½™ ${results.length} ä¸ªç»“æœ`, 'success');
    }

    // é‡ç½®æ‰«æ
    function resetScan() {
      if (scanner) {
        scanner.reset();
        document.getElementById('resultCount').textContent = '0';
        document.getElementById('scanTime').textContent = '-';
        document.getElementById('resultsContainer').innerHTML =
          '<div style="color: #858585; text-align: center; padding: 20px;">ç­‰å¾…æ‰«æ...</div>';
        log('å·²é‡ç½®æ‰«æ', 'info');
      }
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResults(results) {
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';

      if (results.length === 0) {
        container.innerHTML = '<div style="color: #858585; text-align: center; padding: 20px;">æ— ç»“æœ</div>';
        return;
      }

      const displayLimit = Math.min(results.length, 100);
      for (let i = 0; i < displayLimit; i++) {
        const result = results[i];
        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `
          <span class="address">0x${result.address.toString(16).padStart(8, '0')}</span>
          <span class="value">${result.value}</span>
          <span class="type">${result.type}</span>
          <button class="action-btn" onclick="addToWatch(${result.address}, '${result.type}')">â• ç›‘æ§</button>
        `;
        container.appendChild(item);
      }

      if (results.length > 100) {
        const note = document.createElement('div');
        note.style.cssText = 'color: #858585; text-align: center; padding: 10px;';
        note.textContent = `... è¿˜æœ‰ ${results.length - 100} ä¸ªç»“æœæœªæ˜¾ç¤º`;
        container.appendChild(note);
      }
    }

    // ä¿®æ”¹å†…å­˜
    function modifyMemory() {
      if (!scanner) {
        log('é”™è¯¯: æœªè¿æ¥åˆ° WASM å†…å­˜', 'error');
        return;
      }

      const addressStr = document.getElementById('modifyAddress').value;
      const value = parseFloat(document.getElementById('modifyValue').value);
      const type = document.getElementById('modifyType').value;

      if (!addressStr || isNaN(value)) {
        log('é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„åœ°å€å’Œå€¼', 'error');
        return;
      }

      // è§£æåœ°å€ï¼ˆæ”¯æŒåå…­è¿›åˆ¶å’Œåè¿›åˆ¶ï¼‰
      const address = addressStr.startsWith('0x')
        ? parseInt(addressStr, 16)
        : parseInt(addressStr, 10);

      try {
        scanner.writeValue(address, value, type);
        log(`æˆåŠŸä¿®æ”¹ 0x${address.toString(16)} = ${value} (${type})`, 'success');
      } catch (e) {
        log(`ä¿®æ”¹å¤±è´¥: ${e.message}`, 'error');
      }
    }

    // æ·»åŠ åˆ°ç›‘æ§åˆ—è¡¨
    window.addToWatch = function(address, type) {
      const existing = watchList.find(item => item.address === address);
      if (existing) {
        log('è¯¥åœ°å€å·²åœ¨ç›‘æ§åˆ—è¡¨ä¸­', 'info');
        return;
      }

      watchList.push({ address, type });
      log(`å·²æ·»åŠ  0x${address.toString(16)} åˆ°ç›‘æ§åˆ—è¡¨`, 'success');
      updateWatchList();
    };

    // æ¸…ç©ºç›‘æ§åˆ—è¡¨
    function clearWatchList() {
      watchList = [];
      updateWatchList();
      log('å·²æ¸…ç©ºç›‘æ§åˆ—è¡¨', 'info');
    }

    // æ›´æ–°ç›‘æ§åˆ—è¡¨æ˜¾ç¤º
    function updateWatchList() {
      const container = document.getElementById('watchList');
      container.innerHTML = '';

      if (watchList.length === 0) {
        container.innerHTML = '<div style="color: #858585; text-align: center; padding: 20px;">ç›‘æ§åˆ—è¡¨ä¸ºç©º</div>';
        return;
      }

      watchList.forEach((item, index) => {
        const value = scanner ? scanner.readValue(item.address, item.type) : 'N/A';
        const div = document.createElement('div');
        div.className = 'watch-item';
        div.innerHTML = `
          <span class="address">0x${item.address.toString(16).padStart(8, '0')}</span>
          <span class="value">${value}</span>
          <span class="type">${item.type}</span>
          <button class="action-btn danger" onclick="removeFromWatch(${index})">ğŸ—‘ï¸</button>
        `;
        container.appendChild(div);
      });
    }

    // ä»ç›‘æ§åˆ—è¡¨ç§»é™¤
    window.removeFromWatch = function(index) {
      const item = watchList[index];
      watchList.splice(index, 1);
      log(`å·²ç§»é™¤ 0x${item.address.toString(16)} ä»ç›‘æ§åˆ—è¡¨`, 'info');
      updateWatchList();
    };

    // å¯åŠ¨ç›‘æ§å®šæ—¶å™¨
    function startWatchInterval() {
      if (watchInterval) {
        clearInterval(watchInterval);
      }

      watchInterval = setInterval(() => {
        if (scanner && watchList.length > 0) {
          updateWatchList();
        }
      }, 1000);
    }

    // åˆå§‹åŒ–
    log('WASM Memory Scanner å·²åŠ è½½', 'info');
    log('è¯·åœ¨æ§åˆ¶å°è¿è¡Œ: attachScanner(wasmInstance.exports.memory)', 'info');
  </script>
</body>
</html>
